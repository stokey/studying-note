# 操作系统


### 多道程序设计：
+ 概念：`指让多个程序同事进入计算机的主存储器进行计算`
+ 特点
	+ CPU与外部设备充分并行
	+ 外部设备之间充分并行
	+ 发挥CPU的使用效率
	+ 提高单位时间的算题量
+ 实现
	+ 为进入内存执行的程序建立管理实体：`进程`
	+ OS应能管理与控制进程程序的执行
	+ OS协调管理各类资源在进程间的使用
		+ 处理器的管理和调度
		+ 主存储器的管理和调度
		+ 其他资源的管理和调度
+ 实现要点
	+ 如何使用资源：调用操作系统提供的服务例程（如何陷入操作系统）
	+ 如何复用CPU：调度程序（在CPU空闲时让其他程序运行）
	+ 如何使CPU与I/O设备充分并行：设备控制器与通道（专用的I/O处理器）
	+ 如何让正在运行的程序让出CPU：中断（中断正在执行的程序，引入OS处理） 

### 命令解释程序（操作接口）
+ 处理过程
	+ OS启动命令解释程序，输出命令提示符，等待键盘中断／鼠标点击／多通道识别
	+ 每当用户输入一条命令（暂存在命令缓冲区）并按回车换行时，申请中断
	+ CPU响应后，将控制权交给命令解释程序，接着都去命令缓冲区内容，分析命令、接受参数，执行处理代码
	+ 前台命令（命令按序执行，一个命令执行后在接收新的命令）执行结束后，再次输出命令提示符，等待下一条命令
	+ 后台命令（不管命令是否结束，直接接收下一条命令）处理启动后，即可接收下条命令 

### 人机交互发展
+ WIMP界面
	+ 缘起：70年代后期`Xerox`的原型机Start
	+ 特征：窗口（`Windows`）、图标（`Icons`）、菜单（`Menu`）和指示装置（`Pointing Devices`）为基础的图形用户界面WIMP 
	+ 得益：Apple最初采用并大力推广
	+ 时间：1990年代开始广泛使用
	+ 不足：不允许同时使用多个交互通道，从而产生人-机交互的不平衡
+ 多媒体计算机
	+ 缘起：1985年的MPC
	+ 概念：把音频、视频、图形图像和人机交互控制结合起来，进行综合处理的计算机操作系统
	+ 构成：多媒体硬件平台、多媒体OS、图形用户接口、多媒体数据开发工具
	+ 提供与时间有关的时变媒体界面，既控制信息呈现，也控制何时呈现／如何呈现
	+ 人机交互界面需要使用多种媒体，同时支持多通道交互整合，改善用户体验
+ 虚拟现实系统（VR）
	+ 缘起：1980年代的虚拟现实新型用户界面
	+ VR通过计算机模拟三维虚拟世界，根据`观察点`、观察点改变的`导航`和对周围对象的`操作`，来模拟`临境`（身临其境）的感觉
	+ 支持多通道交互整合，提供良好的用户体验
	+ 支持用户主动参与的高度自然的三维HCI（人机交互），以及语音识别、头部跟踪、视觉跟踪、姿势识别等新型HCI
	+ 允许用户产生模糊和不精确的输入

## 程序接口
+ 概念
	+ 操作系统的程序接口——系统调用
	+ 操作系统实现的完成某种特定功能的过程。为所有运行程序提供访问操作系统的接口 
+ 系统调用的实现机制
	+ 陷入处理机制：计算机系统中控制和实现系统调用的机制
	+ 陷入指令：也称为访管指令，或异常中断指令。计算机系统为实现系统调用而引入处理器中断的指令
	+ 每个系统调用都事先规定了编号，并在约定寄存器中规定了传递给内部处理程序的参数
+ 系统调用的实现要点
	+ 编写系统调用处理程序
	+ 设计一张系统调用入口地址表，每个入口地址指向一个系统调用的处理程序，并包含系统调用自带参数的个数
	+ 陷入处理机制需开辟现场保护区，以保存发生系统调用时的处理器现场
+ 系统调用流程图

![img](./images/call_system_flow_chart.png)     

## 系统结构
+ 操作系统软件的结构设计
	+ OS构件：内核、进程、线程、管程等 
	+ 设计概念：模块化、层次化、虚拟化
	+ 内核设计是OS设计中最为复杂的部分
+ 操作系统内核
	+ 单内核（`主体`）：内核中各部件杂然混居的形态，始于1960年代，广泛使用。如Unix／Linux，及Windows（自称采用混合内核的CS结构）
	+ 微内核：1980年代始，强调结构性部件与功能性部件的分离（以进程的方式运行与操作系统之外），大部分OS研究都集中在此（`由于效率问题，只存在于研究领域，市场上不采用`）
	+ 混合内核：微内核和单内核的折中，较多组建在核心态中运行（`Windows，提升有限`）
	+ 外内核：尽可能减少内核的软件抽象化和传统微内核的消息传递机制，使得开发者专注于硬件的抽象化；部分嵌入式系统使用
+ 操作系统结构层次图

![img](./images/os_level.png) 

详细图：

![img](./images/os_level_details.png)


## 处理器与寄存器
+ 处理器（CPU）部件示意图

![img](./images/cpu_struct_info.png)

+ 寄存器
	+ 用户程序可见寄存器
		+ 可以使程序源码减少访问主存储器的次数，提高指令执行的效率
		+ 所有程序可使用，包括应用程序和系统程序
		+ 分类
			+ 数据寄存器：又称为通用寄存器（`AX,BX,CX,DX`）
			+ 地址寄存器：索引（`SI、DI`）、栈指针（`SP、BP`）、段地址（`CS、DS、SS、ES`）等寄存器   
			+ 控制与状态寄存器
				+ 用于控制处理器的操作，主要被具有有特权的操作系统程序使用，以控制程序的执行
				+ 程序计数器PC：存储将取指令的地址
				+ 指令寄存器IR：存储最近使用的指令
				+ 条件码CC：CPU为指令操作结果设置的位，标志正、负、零、溢出等结果
				+ 标志位：中断位、中断允许位、中断屏蔽位、处理器模式位、内存保护位等等
	+ 程序状态字PSW
		+ 操作系统中指记录当前程序运行的动态信息，通常包含:
			+ 程序计数器，指令寄存器，条件码
			+ 中断字，中断允许/禁止，中断屏蔽，处理器模式，内存保护，调试控制
		+ PSW也是计算机系统的寄存器
			+ 通常设置一组控制与状态寄存器
			+ 也可以专设一个PSW寄存器（极少操作系统）    